<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Products - Kajwelo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/FinalHomePage.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 2rem;
      min-height: calc(100vh - 120px);
    }

    .sidebar {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      height: fit-content;
      position: sticky;
      top: 120px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .sidebar h3 {
      margin-bottom: 1.5rem;
      color: #333;
      font-size: 1.25rem;
      text-align: center;
      padding-bottom: 1rem;
      border-bottom: 2px solid #6366f1;
    }

    .filter-section {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #e9ecef;
    }

    .filter-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .filter-title {
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
      font-size: 1rem;
    }

    .filter-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      padding: 0.25rem;
      border-radius: 4px;
    }

    .filter-option:hover {
      background: #f8f9fa;
    }

    .filter-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #6366f1;
    }

    .filter-option label {
      cursor: pointer;
      color: #666;
      font-size: 0.95rem;
      flex: 1;
    }

    .price-range {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .price-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.9rem;
      color: #666;
    }

    .price-range-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e9ecef;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .price-range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #6366f1;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .price-range-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #6366f1;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .clear-filters {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 0.75rem;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      margin-top: 1rem;
      transition: all 0.2s;
      font-weight: 500;
    }

    .clear-filters:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }

    .main-contents {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      min-height: fit-content;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e9ecef;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: #333;
    }

    .results-info {
      color: #666;
      font-size: 0.95rem;
      margin-top: 0.25rem;
      display: none;
    }

    .sort-options {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .sort-select {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 2rem;
    }

    .product-card {
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .product-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }

    .product-image {
      width: 100%;
      height: 300px;
      position: relative;
      overflow: hidden;
    }

    .product-badge {
      position: absolute;
      top: 1rem;
      left: 1rem;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 1;
    }

    .badge-bestseller {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    }

    .badge-new {
      background: linear-gradient(135deg, #00d2d3, #01a3a4);
    }

    .badge-trending {
      background: linear-gradient(135deg, #ffa726, #f57c00);
    }

    .badge-limited {
      background: linear-gradient(135deg, #9c88ff, #8c7ae6);
    }

    .badge-sale {
      background: linear-gradient(135deg, #ff9ff3, #f368e0);
    }

    .product-info {
      padding: 1.5rem;
    }

    .product-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .product-category {
      font-size: 0.9rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
    }

    .product-price {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .current-price {
      font-size: 1.25rem;
      font-weight: 700;
      color: #e74c3c;
    }

    .original-price {
      font-size: 1rem;
      color: #999;
      text-decoration: line-through;
    }

    .product-rating {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stars {
      color: #ffc107;
      font-size: 0.9rem;
    }

    .rating-count {
      color: #666;
      font-size: 0.9rem;
    }

    .mobile-filter-toggle {
      display: none;
      background: #6366f1;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      cursor: pointer;
      font-weight: 500;
      width: 100%;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid #e9ecef;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: 0.75rem 1rem;
      border: 1px solid #ddd;
      background: white;
      color: #666;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 40px;
    }

    .pagination button:hover:not(.active) {
      background: #f8f9fa;
      transform: translateY(-1px);
    }

    .pagination button.active {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
    }

    .pagination button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8f9fa;
      color: #999;
    }

    .pagination button[disabled]:hover {
      background: #f8f9fa;
      transform: none;
    }

    .no-products {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }

    .no-products h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #333;
    }

    /* Pagination Styles */
    .pagination-container {
      margin-top: 2rem;
      display: flex;
      justify-content: center;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .pagination-btn {
      background: #6366f1;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #4f46e5;
      transform: translateY(-1px);
    }

    .pagination-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }

    .page-numbers {
      display: flex;
      gap: 0.25rem;
    }

    .page-number {
      background: white;
      color: #6366f1;
      border: 2px solid #6366f1;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 40px;
      text-align: center;
    }

    .page-number:hover {
      background: #6366f1;
      color: white;
    }

    .page-number.active {
      background: #6366f1;
      color: white;
    }

    .page-number.dots {
      border: none;
      cursor: default;
      background: transparent;
      color: #666;
    }

    .page-number.dots:hover {
      background: transparent;
      color: #666;
    }

    /* Responsive pagination */
    @media (max-width: 768px) {
      .pagination {
        padding: 0.75rem 1rem;
        gap: 0.25rem;
      }

      .pagination-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
      }

      .page-number {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
        min-width: 35px;
      }

      .page-numbers {
        gap: 0.15rem;
      }
    }

    @media (max-width: 480px) {
      .pagination {
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
      }

      .page-numbers {
        order: 2;
      }

      .pagination-btn {
        order: 1;
        width: 100%;
        justify-content: center;
      }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 260px 1fr;
        padding: 1.5rem;
      }
    }

    @media (max-width: 992px) {
      .container {
        grid-template-columns: 240px 1fr;
        padding: 1rem;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        padding: 1rem;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
        overflow-y: auto;
        width: 300px;
        max-width: 80vw;
      }

      .sidebar.active {
        left: 0;
      }

      .mobile-filter-toggle {
        display: block;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
      }

      .nav-links {
        display: none;
      }

      .content-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .sort-options {
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 0.5rem;
      }

      .main-contents,
      .sidebar {
        padding: 1rem;
      }

      .products-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .product-image {
        height: 250px;
      }

      .pagination button {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
      }
    }

    /* Filter overlay for mobile */
    .filter-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .filter-overlay.active {
      display: block;
    }

    /* Subcategory sections */
    .subcategory-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .subcategory-section-title {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .subcategory-options {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 1rem;
    }

    /* Brand filter layout and truncation */
    .brand-options {
      display: flex;
      flex-direction: row;
      gap: 0.3rem;
    }

    .brand-col {
      flex: 1;
      min-width: 0;
    }

    .brand-options label {
      display: inline-block;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>

<body>

  <div class="filter-overlay" id="filterOverlay" onclick="toggleFilters()"></div>

  <div class="container" id="maincontainer">
    <aside class="sidebar" id="sidebar">
      <h3>Filters</h3>

      <!-- Categories -->
      <div class="filter-section">
        <div class="filter-title">Category</div>
        <div class="filter-options">
          <div class="filter-option">
            <input type="checkbox" id="category-men" value="men" />
            <label for="category-men">Men</label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="category-women" value="women" />
            <label for="category-women">Women</label>
          </div>
        </div>
      </div>

      <!-- Sub category filteration -->
      <div class="filter-section">
        <div class="filter-title">SubCategory</div>
        <div class="subcategory-options">
          <!-- Men's subcategories -->
          <div id="men-subcategories" class="subcategory-section">
            <div class="subcategory-section-title">Men</div>
            <div class="filter-options">
              <div class="filter-option">
                <input type="checkbox" id="subcategory-suits" value="suits" />
                <label for="subcategory-suits">Suits</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-shirts" value="shirts" />
                <label for="subcategory-shirts">Shirts</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-trousers" value="trousers" />
                <label for="subcategory-trousers">Trousers</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-polo-shirts" value="polo shirts" />
                <label for="subcategory-polo-shirts">Polo Shirts</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-t-shirts" value="t-shirts" />
                <label for="subcategory-t-shirts">T-shirts</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-shorts" value="shorts" />
                <label for="subcategory-shorts">Shorts</label>
              </div>
            </div>
          </div>

          <!-- Women's subcategories -->
          <div id="women-subcategories" class="subcategory-section">
            <div class="subcategory-section-title">Women</div>
            <div class="filter-options">
              <div class="filter-option">
                <input type="checkbox" id="subcategory-dresses" value="dresses" />
                <label for="subcategory-dresses">Dresses</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-skirts" value="skirts" />
                <label for="subcategory-skirts">Skirts</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-blouses" value="blouses" />
                <label for="subcategory-blouses">Blouses</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-cardigans" value="cardigans" />
                <label for="subcategory-cardigans">Cardigans</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-pants" value="pants" />
                <label for="subcategory-pants">Pants</label>
              </div>
              <div class="filter-option">
                <input type="checkbox" id="subcategory-sets" value="sets" />
                <label for="subcategory-sets">Sets</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Brands Filter -->
      <div class="filter-section">
        <div class="filter-title">Brand</div>
        <div class="filter-options" style="display: flex; flex-direction: row; gap: 2em">
          <div id="left">
            <div class="filter-option">
              <input type="checkbox" id="brand-nike" value="nike" />
              <label for="brand-nike">Nike</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="brand-adidas" value="adidas" />
              <label for="brand-adidas">Adidas</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="brand-zara" value="zara" />
              <label for="brand-zara">Zara</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="brand-hm" value="h&m" />
              <label for="brand-hm">H&M</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="brand-lc" value="lc" />
              <label for="brand-lc">Lc</label>
            </div>
          </div>
          <div id="right">
            <div class="filter-option">
              <input type="checkbox" id="brand-defacto" value="defacto" />
              <label for="brand-defacto">Defacto</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="brand-max" value="max" />
              <label for="brand-max">Max</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="brand-prada" value="prada" />
              <label for="brand-prada">Prada</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="brand-versace" value="versace" />
              <label for="brand-versace">Versace</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="brand-puma" value="puma" />
              <label for="brand-puma">Puma</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter for size -->
      <div class="filter-section">
        <div class="filter-title">Size</div>
        <div class="filter-options" style="display: flex; flex-direction: row; gap: 2em">
          <div id="sizeleft">
            <div class="filter-option">
              <input type="checkbox" id="size-xs" value="xs" />
              <label for="size-xs">XS</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="size-s" value="s" />
              <label for="size-s">S</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="size-m" value="m" />
              <label for="size-m">M</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="size-l" value="l" />
              <label for="size-l">L</label>
            </div>
          </div>
          <div id="sizeright">
            <div class="filter-option">
              <input type="checkbox" id="size-xl" value="xl" />
              <label for="size-xl">XL</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="size-xxl" value="xxl" />
              <label for="size-xxl">XXL</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="size-xxxl" value="xxxl" />
              <label for="size-xxxl">XXXL</label>
            </div>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-title">Price Range</div>
        <div class="price-range">
          <div class="price-display">
            <span>$<span id="min-price-display">0</span></span>
            <span>$<span id="max-price-display">500</span></span>
          </div>
          <input type="range" class="price-range-slider" id="price-slider" min="0" max="500" value="500" />
        </div>
      </div>

      <div class="clear-filters" onclick="clearAllFilters()">
        Clear All Filters
      </div>
    </aside>

    <main class="main-contents">
      <button class="mobile-filter-toggle" onclick="toggleFilters()">
        🔍 Show Filters
      </button>

      <div class="content-header">
        <div>
          <h1 class="page-title">Products</h1>
          <div class="results-info">
            Showing <span id="showing-count">8</span> of
            <span id="total-count">8</span> products
          </div>
        </div>
        <div class="sort-options">
          <label for="sort">Sort by:</label>
          <select class="sort-select" id="sort">
            <option value="featured">Featured</option>
            <option value="price-low">Price: Low to High</option>
            <option value="price-high">Price: High to Low</option>
          </select>
        </div>
      </div>

      <div class="products-grid" id="products-grid">
        <!-- Products will be populated by JavaScript -->
      </div>

      <div class="no-products" id="no-products" style="display: none">
        <h3>No products found</h3>
        <p>Try adjusting your filters to see more results.</p>
      </div>

      <!-- Pagination -->
      <div class="pagination-container" id="pagination-container" style="display: none;">
        <div class="pagination">
          <button class="pagination-btn" id="prev-page" disabled>
            <i class="fas fa-chevron-left"></i> Previous
          </button>
          <div class="page-numbers" id="page-numbers">
            <!-- Page numbers will be generated here -->
          </div>
          <button class="pagination-btn" id="next-page">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>


    </main>
  </div>
  <script src="../utils/logout.js" type="module"></script>
  <script type="module">
    import { Storage } from "../utils/localStorageHelper.js";
    import { Seller } from "../models/Seller.js";
    import { retrive } from "../models/Filteration.js";
    import { Auth } from "../utils/auth.js";
    import { renderProducts as displayall } from "/cardGeneratot/card.js";

    // Load verified and visible products from storage
    const valid = retrive.allVerifiedAndVisibleProducts();
    const allProducts = valid.success ? valid.products : [];
    let dynamicProducts = [];

    // Filter state
    const filters = {
      category: [],
      subcategory: [],
      brand: [],
      size: [],
      maxPrice: 500,
    };

    let filteredProducts = [];
    let currentPage = 1;
    const productsPerPage = 12; // Show 12 products per page

    // Initialize the page
    function init() {
      buildProductsDataset();
      renderBrandFilters();
      setupEventListeners();
      updatePriceDisplay();
      updateSubcategoryVisibility();
      const applied = applyInitialFilterIfAny();
      if (!applied) {
        filteredProducts = [...dynamicProducts];
        renderProducts();
        updateResultsInfo();
      }
    }

    function normalizeSlug(value) {
      return String(value || "").toLowerCase().trim();
    }

    function brandToIdSlug(brand) {
      const map = {
        "h&m": "hm",
        "h & m": "hm",
        "lc waikiki": "lc",
      };
      const v = normalizeSlug(brand);
      if (map[v]) return map[v];
      // strip non-alphanumerics for safety
      return v.replace(/[^a-z0-9]+/g, "");
    }

    function applyInitialFilterIfAny() {
      try {
        const raw = localStorage.getItem("initialFilter");
        console.log(raw)
        if (!raw) return false;
        const obj = JSON.parse(raw);
        const by = normalizeSlug(obj.by);
        const value = normalizeSlug(obj.value);
        console.log(value)
        // Reset state
        filters.category = [];
        filters.subcategory = [];
        filters.brand = [];
        filters.size = [];

        let checkboxId = null;
        switch (by) {
          case "category":
            checkboxId = `category-${value}`;
            filters.category = [value];
            break;
          case "subcategory":
            checkboxId = `subcategory-${value}`;
            filters.subcategory = [value];
            break;
          case "brand":
            const brandSlug = brandToIdSlug(obj.value);
            checkboxId = `brand-${brandSlug}`;
            filters.brand = [brandSlug];
            break;
          case "size":
            checkboxId = `size-${value}`;
            filters.size = [value];
            break;
          default:
            // Unknown filter, render all
            filteredProducts = [...dynamicProducts];
            renderProducts();
            updateResultsInfo();
            localStorage.removeItem("initialFilter");
            return true;
        }

        const cb = document.getElementById(checkboxId);
        if (cb) cb.checked = true;

        // Update any dependent UI (like subcategories vis)
        updateSubcategoryVisibility();
        applyFilters();
        updateResultsInfo();
        localStorage.removeItem("initialFilter");
        return true;
      } catch (e) {
        console.warn("Failed to apply initial filter:", e);
        return false;
      }
    }

    function buildProductsDataset() {
      const users = Storage.get("users", []);
      const sellers = users.filter(u => (u instanceof Seller) || u.role === 'seller');
      const sellerIdToBrand = new Map(sellers.map(s => [s.id, (s.brandName || '').toLowerCase()]));

      dynamicProducts = allProducts.map(p => {
        const sizesFromStock = Array.isArray(p.stock) ? p.stock.map(s => String(s.size).toLowerCase()) : [];
        const sizesFromAvailable = Array.isArray(p.availableSizes) ? p.availableSizes.map(s => String(s).toLowerCase()) : [];
        const mergedSizes = Array.from(new Set([...sizesFromAvailable, ...sizesFromStock]));
        return {
          ...p,
          __brand: (sellerIdToBrand.get(p.sellerId) || '').toLowerCase(),
          __brandSlug: brandToIdSlug(sellerIdToBrand.get(p.sellerId) || ''),
          __sizes: mergedSizes,
          __category: (p.category || '').toLowerCase(),
          __subcategory: (p.subcategory || '').toLowerCase(),
          __effectivePrice: (p.salePrice ?? p.price) || 0
        };
      });

      // Dynamically set price slider max to the highest effective price
      const maxPrice = dynamicProducts.reduce((mx, p) => Math.max(mx, p.__effectivePrice || 0), 0);
      const slider = document.getElementById('price-slider');
      const maxSpan = document.getElementById('max-price-display');
      if (slider) {
        const rounded = Math.ceil(maxPrice || 0);
        slider.max = String(rounded);
        slider.value = String(rounded);
        filters.maxPrice = rounded;
      }
      if (maxSpan && slider) {
        maxSpan.textContent = slider.max;
      }
    }

    function renderBrandFilters() {
      try {
        const users = Storage.get('users', []);
        const sellers = users.filter(u => (u instanceof Seller) || u.role === 'seller');
        const brandNames = Array.from(new Set(sellers
          .map(s => (s.brandName || '').trim())
          .filter(Boolean)));

        const brandSection = Array.from(document.querySelectorAll('.filter-section'))
          .find(sec => (sec.querySelector('.filter-title')?.textContent || '').trim().toLowerCase() === 'brand');
        if (!brandSection) return;
        const options = brandSection.querySelector('.filter-options');
        if (!options) return;

        const left = [];
        const right = [];
        brandNames.forEach((name, idx) => {
          const slug = brandToIdSlug(name);
          const html = `
              <div class="filter-option">
                <input type="checkbox" id="brand-${slug}" value="${slug}" />
                <label for="brand-${slug}">${name}</label>
              </div>`;
          (idx % 2 === 0 ? left : right).push(html);
        });

        options.innerHTML = `
            <div class="brand-options">
              <div class="brand-col" id="left">${left.join('')}</div>
              <div class="brand-col" id="right">${right.join('')}</div>
            </div>
          `;
      } catch (e) {
        console.warn('Failed to render brand filters', e);
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Filter checkboxes
      document
        .querySelectorAll('input[type="checkbox"]')
        .forEach((checkbox) => {
          checkbox.addEventListener("change", handleFilterChange);
        });

      // Price slider
      document
        .getElementById("price-slider")
        .addEventListener("input", handlePriceChange);

      // Sort dropdown
      document
        .getElementById("sort")
        .addEventListener("change", handleSortChange);

      // Category checkboxes specifically for updating subcategory visibility
      document
        .getElementById("category-men")
        .addEventListener("change", updateSubcategoryVisibility);
      document
        .getElementById("category-women")
        .addEventListener("change", updateSubcategoryVisibility);

      // Pagination buttons
      document.getElementById("prev-page").addEventListener("click", () => {
        if (currentPage > 1) {
          changePage(currentPage - 1);
        }
      });

      document.getElementById("next-page").addEventListener("click", () => {
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        if (currentPage < totalPages) {
          changePage(currentPage + 1);
        }
      });
    }

    // Update subcategory visibility based on selected categories
    function updateSubcategoryVisibility() {
      const menChecked = document.getElementById("category-men").checked;
      const womenChecked = document.getElementById("category-women").checked;

      const menSubcategories = document.getElementById("men-subcategories");
      const womenSubcategories = document.getElementById(
        "women-subcategories"
      );

      // Show/hide based on category selection
      if (menChecked && !womenChecked) {
        menSubcategories.style.display = "block";
        womenSubcategories.style.display = "none";
      } else if (womenChecked && !menChecked) {
        menSubcategories.style.display = "none";
        womenSubcategories.style.display = "block";
      } else {
        // Show both if both or none are selected
        menSubcategories.style.display = "block";
        womenSubcategories.style.display = "block";
      }
    }

    // Handle filter changes
    function handleFilterChange(e) {
      let [filterType, value] = e.target.id.split("-");

      // Special handling for category changes
      if (filterType === "category") {
        if (e.target.checked) {
          if (!filters[filterType].includes(value)) {
            filters[filterType].push(value);
          }
        } else {
          filters[filterType] = filters[filterType].filter(
            (item) => item !== value
          );
        }
        // Update subcategory visibility when category changes
        updateSubcategoryVisibility();
      }
      // Standard handling for other filters
      else {
        if (e.target.checked) {

          if (!filters[filterType].includes(value)) {
            if (value == "t") {
              value = "t-shirts"
            } else if (value == "polo") {
              value = "polo shirts"
            }
            filters[filterType].push(value);
          }
        } else {
          if (value == "t") {
            value = "t-shirts"
          } else if (value == "polo") {
            value = "polo shirts"
          }
          filters[filterType] = filters[filterType].filter(
            (item) => item !== value
          );
        }
      }

      applyFilters();
    }

    // Handle price change
    function handlePriceChange(e) {
      filters.maxPrice = parseInt(e.target.value);
      updatePriceDisplay();
      applyFilters();
    }

    // Update price display
    function updatePriceDisplay() {
      document.getElementById("max-price-display").textContent =
        filters.maxPrice;
    }

    // Handle sort change
    function handleSortChange(e) {
      const sortValue = e.target.value;
      sortProducts(sortValue);
      renderProducts();
    }

    // Apply filters
    function applyFilters() {
      filteredProducts = dynamicProducts.filter((product) => {
        //console.log(filters.subcategory)
        // Category filter (case-insensitive)
        if (filters.category.length > 0 && !filters.category.includes(product.__category)) {
          return false;
        }

        // SubCategory filter
        if (filters.subcategory.length > 0 && !filters.subcategory.includes(product.__subcategory)) {
          return false;
        }
        //console.log(product.__subcategory)

        // Brand filter (derived slug from seller brandName)
        if (filters.brand.length > 0 && !filters.brand.includes(product.__brandSlug)) {
          return false;
        }

        // Size filter (uses availableSizes or stock sizes)
        if (filters.size.length > 0 && !product.__sizes.some(size => filters.size.includes(size))) {
          return false;
        }

        // Price filter uses effective price (salePrice if present)
        if (product.__effectivePrice > filters.maxPrice) {
          return false;
        }

        return true;
      });

      currentPage = 1;
      renderProducts();
      updateResultsInfo();
    }

    // Sort products
    function sortProducts(sortValue) {
      switch (sortValue) {
        case "price-low":
          filteredProducts.sort((a, b) => (a.__effectivePrice) - (b.__effectivePrice));
          break;
        case "price-high":
          filteredProducts.sort((a, b) => (b.__effectivePrice) - (a.__effectivePrice));
          break;
        case "newest":
          filteredProducts.sort((a, b) => b.id - a.id);
          break;
        default:
          // Featured - restore original order
          filteredProducts = filteredProducts.sort((a, b) => a.id - b.id);
      }
    }
    window.godetails = function godetails(id) {
      const product = allProducts.find(p => p.id === id);
      localStorage.setItem("selectedProduct", JSON.stringify(product));
      window.location.href = "/cardGeneratot/productDetail.html";
    }

    // Render products
    function renderProducts() {
      const grid = document.getElementById("products-grid");
      const noProducts = document.getElementById("no-products");
      const paginationContainer = document.getElementById("pagination-container");

      if (filteredProducts.length === 0) {
        grid.style.display = "none";
        noProducts.style.display = "block";
        paginationContainer.style.display = "none";
        return;
      }

      grid.style.display = "grid";
      noProducts.style.display = "none";

      // Calculate pagination
      const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
      const startIndex = (currentPage - 1) * productsPerPage;
      const endIndex = startIndex + productsPerPage;
      const productsToShow = filteredProducts.slice(startIndex, endIndex);

      grid.innerHTML = productsToShow
        .map(
          (product) => `
          <div class="product-card">
            <div class="product-image" style="background: url(${product.image}) no-repeat center center; background-size: cover;">
              <div class="product-overlay">
                <button class="quick-view-btn" data-product-id="${product.id}"><i class="fa-solid fa-cart-shopping"></i> Add to Cart</button>
                <button class="Addwishlist-btn wishlist-btn" data-product-id="${product.id}">♡</button>
              </div>
            </div>
            <div class="product-info" onclick="godetails('${product.id}')">
              <div class="product-title">${product.name}</div>
              <div class="product-category">${product.category} / ${product.subcategory}</div>
              <div class="product-price">
                <span class="current-price">$${product.salePrice ? product.salePrice : product.price}</span>
                ${product.salePrice ? `<span class="original-price">$${product.price}</span>` : ""}
              </div>
            </div>
          </div>
        `)
        .join("");

      // Wire up Add to Cart buttons
      document.querySelectorAll('.quick-view-btn').forEach(btn => {
        btn.addEventListener('click', function (event) {
          console.log("clicked");
          event.stopPropagation();
          const productId = this.dataset.productId
          const product = allProducts.find(p => p.id === productId);
          if (!product) return;
          //console.log(product);
          
          let loggedInUser = Auth.getCurrentUser();
          if (!loggedInUser) {
            const confirmed = confirm('You need to log in to add to cart! press ok to continue');
            if (confirmed) {
              window.location.href = '/login.html';
            }
            return;
          }
          //console.log(loggedInUser.cart)
          if (!Array.isArray(loggedInUser.cart)) loggedInUser.cart = [];
          const result =loggedInUser.addToCart(product);
          //console.log(result)
          if(!result.success){
            alert(result.message);
            return;
          }
          localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));

          let users = JSON.parse(localStorage.getItem('users')) || [];
          const userIndex = users.findIndex(u => u.id === loggedInUser.id);
          if (userIndex !== -1) {
            users[userIndex] = loggedInUser;
            localStorage.setItem('users', JSON.stringify(users));
          }

          alert(`${product.name} added to cart!`);
        });
      });

      // Initialize wishlist buttons state and handlers
      document.querySelectorAll('.Addwishlist-btn').forEach(btn => {
        const productId = btn.dataset.productId
        let loggedInUser = Auth.getCurrentUser();
        if (loggedInUser && Array.isArray(loggedInUser.wishlist)) {
          const isInWishlist = loggedInUser.wishlist.some(item => item.id === productId);
          if (isInWishlist) {
            btn.innerHTML = '❤';
            btn.classList.add('active');
          }
        }

        btn.addEventListener('click', function (event) {
          event.stopPropagation();
          const product = allProducts.find(p => p.id === productId);
          if (!product) return;

          let loggedInUser = Auth.getCurrentUser();
          if (!loggedInUser) {
            alert('You need to log in to use wishlist!');
            window.location.href = '/login.html';
            return;
          }
          if (!Array.isArray(loggedInUser.wishlist)) loggedInUser.wishlist = [];

          const existingIndex = loggedInUser.wishlist.findIndex(item => item.id === productId);
          if (existingIndex === -1) {
            loggedInUser.addToWishlist(product);
            this.innerHTML = '❤';
            this.classList.add('active');
          } else {
            loggedInUser.wishlist.splice(existingIndex, 1);
            this.innerHTML = '♡';
            this.classList.remove('active');
          }

          localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
          let users = JSON.parse(localStorage.getItem('users')) || [];
          const userIndex = users.findIndex(u => u.id === loggedInUser.id);
          if (userIndex !== -1) {
            users[userIndex] = loggedInUser;
            localStorage.setItem('users', JSON.stringify(users));
          }
        });
      });

      // Render pagination
      renderPagination(totalPages);
    }

    // Update results info
    function updateResultsInfo() {
      const totalCount = filteredProducts.length;
      const startIndex = (currentPage - 1) * productsPerPage + 1;
      const endIndex = Math.min(currentPage * productsPerPage, totalCount);

      document.getElementById("showing-count").textContent = totalCount > 0 ? `${startIndex}-${endIndex}` : 0;
      document.getElementById("total-count").textContent = totalCount;
    }

    // Render pagination
    function renderPagination(totalPages) {
      const paginationContainer = document.getElementById("pagination-container");
      const pageNumbersContainer = document.getElementById("page-numbers");
      const prevBtn = document.getElementById("prev-page");
      const nextBtn = document.getElementById("next-page");

      if (totalPages <= 1) {
        paginationContainer.style.display = "none";
        return;
      }

      paginationContainer.style.display = "flex";

      // Update prev/next buttons
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      // Generate page numbers
      let pageNumbersHTML = "";
      const maxVisiblePages = 5;

      if (totalPages <= maxVisiblePages) {
        // Show all pages if total is small
        for (let i = 1; i <= totalPages; i++) {
          pageNumbersHTML += `<button class="page-number ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
        }
      } else {
        // Show smart pagination with dots
        if (currentPage <= 3) {
          // Show first 3 pages + dots + last page
          for (let i = 1; i <= 3; i++) {
            pageNumbersHTML += `<button class="page-number ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
          }
          pageNumbersHTML += `<span class="page-number dots">...</span>`;
          pageNumbersHTML += `<button class="page-number" data-page="${totalPages}">${totalPages}</button>`;
        } else if (currentPage >= totalPages - 2) {
          // Show first page + dots + last 3 pages
          pageNumbersHTML += `<button class="page-number" data-page="1">1</button>`;
          pageNumbersHTML += `<span class="page-number dots">...</span>`;
          for (let i = totalPages - 2; i <= totalPages; i++) {
            pageNumbersHTML += `<button class="page-number ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
          }
        } else {
          // Show first page + dots + current page + dots + last page
          pageNumbersHTML += `<button class="page-number" data-page="1">1</button>`;
          pageNumbersHTML += `<span class="page-number dots">...</span>`;
          for (let i = currentPage - 1; i <= currentPage + 1; i++) {
            pageNumbersHTML += `<button class="page-number ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
          }
          pageNumbersHTML += `<span class="page-number dots">...</span>`;
          pageNumbersHTML += `<button class="page-number" data-page="${totalPages}">${totalPages}</button>`;
        }
      }

      pageNumbersContainer.innerHTML = pageNumbersHTML;

      // Add event listeners to page numbers
      pageNumbersContainer.querySelectorAll('.page-number:not(.dots)').forEach(btn => {
        btn.addEventListener('click', () => {
          const page = parseInt(btn.dataset.page);
          changePage(page);
        });
      });
    }

    // Change page
    function changePage(page) {
      currentPage = page;
      renderProducts();
      updateResultsInfo();

      // Scroll to top of products section
      document.getElementById("products-grid").scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }



    // Clear all filters
    window.clearAllFilters = function clearAllFilters() {
      // Reset filter object
      filters.category = [];
      filters.subcategory = [];
      filters.brand = [];
      filters.size = [];
      filters.maxPrice = dynamicProducts.reduce((mx, p) => Math.max(mx, p.__effectivePrice || 0), 0);

      // Uncheck all checkboxes
      document
        .querySelectorAll('input[type="checkbox"]')
        .forEach((cb) => (cb.checked = false));

      // Reset price slider
      document.getElementById("price-slider").value = 500;
      updatePriceDisplay();

      // Reset sort
      document.getElementById("sort").value = "featured";

      // Update subcategory visibility
      updateSubcategoryVisibility();

      // Apply filters
      applyFilters();
    }

    // Mobile filter toggle
    window.toggleFilters=function toggleFilters() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("filterOverlay");

      sidebar.classList.toggle("active");
      overlay.classList.toggle("active");

      // Prevent body scroll when filters are open on mobile
      if (sidebar.classList.contains("active")) {
        document.body.style.overflow = "hidden";
      } else {
        document.body.style.overflow = "auto";
      }
    }

    // Initialize everything when DOM is loaded
    document.addEventListener("DOMContentLoaded", function () {
      init();
    });

    // const test = retrive.allProducts().products;
    // console.log(test);
    // displayall(test, "products-grid", "All products");
  </script>
</body>

</html>