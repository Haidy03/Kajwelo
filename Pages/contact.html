<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inbox</title>

    <link rel="stylesheet" href="../CSS/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../CSS/userprofileStyle.css" />
    <link rel="stylesheet" href="../CSS/Finalhomepage.css" />
    <script type="module" src="../utils/logout.js"></script>
  </head>
  <body class="bg-light">
    <!-- Main content -->
    <div class="content-col flex-grow-1">
      <div class="account-section bg-white p-4 rounded min-vh-100">
        <div class="container-fluid py-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Contact Us</h4>
          </div>

          <div class="row">
            <!-- Admin list -->
            <div class="col-3">
              <div
                class="list-group"
                id="admin-list"
                style="max-height: 60vh; overflow: auto"
              >
                <!-- Admin items injected here -->
              </div>
            </div>

            <!-- Chat area -->
            <div class="col-9">
              <div
                class="chat-container d-flex flex-column border rounded p-3 bg-light"
                style="height: 70vh"
              >
                <div id="chat-header" class="mb-2">
                  <h5 id="chat-with" class="mb-0">
                    Select an admin to open chat
                  </h5>
                </div>

                <div
                  id="chat-messages"
                  class="flex-grow-1 overflow-auto mb-3 p-2 bg-white rounded border d-flex flex-column"
                >
                  <!-- messages injected here -->
                </div>

                <div class="input-group">
                  <input
                    type="text"
                    id="chat-input"
                    class="form-control"
                    placeholder="Type a message..."
                  />
                  <button class="btn btn-primary" id="send-btn">
                    <i class="fa fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="../JS/bootstrap.bundle.min.js"></script>

    <script type="module">
      import { Auth } from "../utils/auth.js";
      import { Conversation } from "../models/Conversation.js";
      import { Storage } from "../utils/localStorageHelper.js";

      const adminListEl = document.getElementById("admin-list");
      const chatMessages = document.getElementById("chat-messages");
      const chatInput = document.getElementById("chat-input");
      const sendBtn = document.getElementById("send-btn");
      const chatWithEl = document.getElementById("chat-with");

      let selectedAdminId = null;

      // --- Helpers --------------------------------------------------------------

      // get fresh data from storage / auth
      function getData() {
        const users = Storage.get("users") || [];
        const currentUser =
          Auth.getCurrentUser() || Storage.get("loggedInUser") || null;
        return { users, currentUser };
      }

      // safe timestamp extractor
      function timeValue(m) {
        if (!m) return 0;
        if (m.sentAt) return new Date(m.sentAt).getTime();
        if (m.createdAt) return new Date(m.createdAt).getTime();
        return 0;
      }

      // escape text to avoid HTML injection
      function escapeHtml(unsafe) {
        if (!unsafe) return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // check whether user chats contain a conversation with otherId
      function hasConversation(currentUser, otherId) {
        if (!currentUser || !Array.isArray(currentUser.chats)) return false;
        return currentUser.chats.some((chat) => {
          if (!chat.participants) return false;
          const p = chat.participants;
          return (
            (p.sender === currentUser.id && p.reciever === otherId) ||
            (p.sender === otherId && p.reciever === currentUser.id)
          );
        });
      }

      // Merge messages from currentUser.chats and adminUser.chats for this pair, normalized and sorted
      function gatherMessagesForPair(currentUser, adminUser) {
        const out = [];
        if (!currentUser || !adminUser) return out;

        const pushFrom = (chatOwner, display = true) => {
          if (!Array.isArray(chatOwner.chats)) return;
          chatOwner.chats.forEach((chat) => {
            const p = chat.participants;
            const isPair =
              (p.sender === currentUser.id && p.reciever === adminUser.id) ||
              (p.sender === adminUser.id && p.reciever === currentUser.id);
            if (!isPair) return;

            chat.messages.forEach((m) => {
              // only include messages you want displayed (e.g., currentUser's messages + admin's sent messages)
              if (display) {
                out.push({
                  sender: m.sender || m.senderId || null,
                  content: m.content || m.text || "",
                  sentAt: m.sentAt || m.createdAt || null,
                  raw: m,
                });
              }
            });
          });
        };

        pushFrom(currentUser, true); // always display current user's messages
        pushFrom(adminUser, false); // store adminâ€™s messages, donâ€™t display yet

        out.sort((a, b) => (timeValue(a.raw) || 0) - (timeValue(b.raw) || 0));
        return out;
      }

      // small snippet for admin list
      function getLastMessageSnippet(currentUser, admin) {
        const msgs = gatherMessagesForPair(currentUser, admin);
        if (!msgs.length) return "No messages yet";
        const last = msgs[msgs.length - 1];
        const who = last.sender === currentUser.id ? "You: " : "";
        return who + (last.content || "").slice(0, 50);
      }

      // --- Rendering ------------------------------------------------------------

      // Render the left admin list
      function renderAdminList() {
        const { users, currentUser } = getData();

        adminListEl.innerHTML = "";

        if (!currentUser) {
          adminListEl.innerHTML =
            '<div class="p-2">No logged-in user found.</div>';
          return;
        }

        const admins = users.filter(
          (u) => u.role === "Admin" && u.id !== currentUser.id
        );

        if (!admins.length) {
          adminListEl.innerHTML = '<div class="p-2">No admins available.</div>';
          return;
        }

        admins.forEach((admin) => {
          const lastSnippet = getLastMessageSnippet(currentUser, admin);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "list-group-item list-group-item-action d-flex justify-content-between align-items-start";
          btn.innerHTML = `
        <div class="ms-2 me-auto">
          <div class="fw-bold">${escapeHtml(admin.name)}</div>
          <div class="small text-muted">${escapeHtml(lastSnippet)}</div>
        </div>
      `;
          btn.onclick = () => {
            selectedAdminId = admin.id;
            // update visual selection
            Array.from(adminListEl.children).forEach((ch) =>
              ch.classList.remove("active")
            );
            btn.classList.add("active");
            renderChatForAdmin(admin.id);
          };
          adminListEl.appendChild(btn);
        });

        // auto-select the first admin with a conversation, otherwise first admin
        const firstWithConv = admins.find((ad) =>
          hasConversation(getData().currentUser, ad.id)
        );
        const toSelect = firstWithConv || admins[0];
        // find and click the corresponding button
        const btnToClick = Array.from(adminListEl.children).find((ch) =>
          ch.textContent.includes(toSelect.name)
        );
        if (btnToClick) btnToClick.click();
      }

      // Render messages for a specific admin
      function renderChatForAdmin(adminId) {
        const { users, currentUser } = getData();
        const admin = users.find((u) => u.id === adminId);

        chatMessages.innerHTML = "";

        if (!currentUser || !admin) {
          chatWithEl.textContent = "Select an admin to open chat";
          chatMessages.innerHTML =
            '<div class="p-2 text-muted">No conversation found.</div>';
          return;
        }

        chatWithEl.textContent = `Chat with ${admin.name}`;

        const messages = gatherMessagesForPair(currentUser, admin);

        if (!messages.length) {
          chatMessages.innerHTML =
            '<div class="p-2 text-muted">No messages yet. Say hello ðŸ‘‹</div>';
          return;
        }

        messages.forEach((m) => {
          const div = document.createElement("div");
          div.className = "mb-2 p-2 rounded w-75";
          if (m.sender === currentUser.id) {
            div.classList.add("bg-primary", "text-white", "align-self-end");
          } else {
            div.classList.add("bg-secondary", "text-white", "align-self-start");
          }
          const timeText = m.sentAt ? new Date(m.sentAt).toLocaleString() : "";
          div.innerHTML = `<div>${escapeHtml(
            m.content
          )}</div><div class="small text-white-50 mt-1">${escapeHtml(
            timeText
          )}</div>`;
          chatMessages.appendChild(div);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // --- Sending --------------------------------------------------------------

      sendBtn.addEventListener("click", () => {
        const text = chatInput.value.trim();
        if (!text) return;
        if (!selectedAdminId) {
          alert("Choose an admin to send the message to.");
          return;
        }

        // send (Conversation.send must update localStorage for both users)
        const res = Conversation.send(text, selectedAdminId);

        if (res && res.success === false) {
          alert(res.message || "Failed to send message");
          return;
        }

        // clear, re-render fresh
        chatInput.value = "";
        renderAdminList(); // refresh sidebar snippets
        if (selectedAdminId) renderChatForAdmin(selectedAdminId);
      });

      // Enter to send
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendBtn.click();
      });

      // initial load
      renderAdminList();
    </script>
  </body>
</html>
