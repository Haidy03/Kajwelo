<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kajwelo Account Overview</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../CSS/userprofileStyle.css" />
    <link rel="stylesheet" href="../CSS/Finalhomepage.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.7/css/bootstrap.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />


    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>

      .chat-message {
        max-width: 70%;
        padding: 8px 12px;
        border-radius: 15px;
        margin-bottom: 8px;
        word-wrap: break-word;
      }
      .chat-message.self {
        background-color: #d1e7ff;
        margin-left: auto;
        text-align: right;
      }
      .chat-message.other {
        background-color: #f0f0f0;
        margin-right: auto;
        text-align: left;
      }
      .chat-box {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background: #fff;
      }
    </style>

    <!---->
  </head>
  <body class="bg-light">
    <div class="main-content">
      <!-- Sidebar -->
      <div class="sidebar-col min-vh-100">
        <div class="sidebar-container bg-white border rounded">
          
          <div class="sidebar-content">
            <div class="list-group list-group-flush">
<a
                onclick="location.href='/Pages/userProfile.html'"
                class="list-group-item list-group-item-action d-flex align-items-center"
              >
                <i class="fa fa-user me-2"></i> My Kajwelo profile
              </a>

              <a
                onclick="location.href='/Pages/ordersHistory.html'"
                class="list-group-item list-group-item-action d-flex align-items-center"
              >
                <i class="fa fa-box me-3"></i> Orders
              </a>
              


<div
                class="d-flex align-items-center px-3 py-3 bg-secondary bg-opacity-25 fw-bold"
              >
                                <i class="fa fa-envelope me-3"></i> Inbox

              </div>


              <a
                onclick="location.href='/cardGeneratot/wishlist.html'"
                class="list-group-item list-group-item-action d-flex align-items-center"
              >
                <i class="fa fa-heart me-3"></i> Wishlist
              </a>
            </div>

            <hr class="my-2" />

            <div class="list-group list-group-flush">
              <a
                href="/Pages/accountManage.html"
                class="list-group-item list-group-item-action ps-5"
              >
                Account Management
              </a>

              <a
                href="/Pages/closeAccount.html"
                class="list-group-item list-group-item-action ps-5"
              >
                Close Account
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="content-col">
        <div class="account-section bg-white p-4 rounded min-vh-100">
          <h3 class="mb-4">chats</h3>

          <ul id="chatList" class="list-group"></ul>
    </div>

    <!-- Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="chatModalTitle" class="modal-title">Chat</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="chatBox" class="chat-box"></div>
          </div>
          <div class="modal-footer">
            <input
              type="text"
              id="chatInput"
              class="form-control"
              placeholder="Type a message..."
            />
            <button id="sendBtn" class="btn btn-primary">Send</button>
          </div>
        </div>
      </div>
    </div>



            
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="../utils/logout.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <script type="module">
  import { Storage } from "../utils/localStorageHelper.js";
  import { Auth } from "../utils/auth.js";
  import { Conversation } from "../models/Conversation.js";

  const currentUser = Auth.getCurrentUser();
  const chatList = document.getElementById("chatList");
  const chatBox = document.getElementById("chatBox");
  const chatModalTitle = document.getElementById("chatModalTitle");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");

  let activeConversation = null;
  let activeParticipant = null;

  function participantsMatch(a, b) {
    return (
      (a.sender === b.sender && a.reciever === b.reciever) ||
      (a.sender === b.reciever && a.reciever === b.sender)
    );
  }

  function renderMessages(convo) {
    chatBox.innerHTML = "";
    if (!convo || !Array.isArray(convo.messages)) return;
    convo.messages.forEach((msg) => {
      const div = document.createElement("div");
      div.classList.add("chat-message");
      const senderId = msg.senderId ?? msg.sender; // accept both shapes
      if (senderId === currentUser.id) div.classList.add("self");
      else div.classList.add("other");
      div.innerText = msg.content ?? msg.text ?? "";
      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function loadChatList() {
    chatList.innerHTML = "";
    const users = Storage.get("users", []) || [];
    if (!currentUser || !Array.isArray(currentUser.chats)) return;

    currentUser.chats.forEach((c) => {
      const otherId =
        c.participants.sender === currentUser.id
          ? c.participants.reciever
          : c.participants.sender;
      const otherUser = users.find((u) => u.id === otherId);
      const li = document.createElement("li");
      li.classList.add(
        "list-group-item",
        "d-flex",
        "justify-content-between",
        "align-items-center"
      );
      li.innerText = otherUser?.name || otherId || "Unknown";
      li.style.cursor = "pointer";
      li.onclick = () => {
        activeConversation = c;
        activeParticipant = otherUser || { id: otherId, name: otherId };
        chatModalTitle.innerText = `Chat with ${
          activeParticipant?.name || activeParticipant.id
        }`;
        renderMessages(c);
        const modal = new bootstrap.Modal(
          document.getElementById("chatModal")
        );
        modal.show();
      };
      chatList.appendChild(li);
    });
  }

  // send message and refresh the conversation state
  sendBtn.addEventListener("click", () => {
    const text = chatInput.value.trim();
    if (!text || !activeParticipant) return;

    Conversation.send(text, activeParticipant.id);

    const users = Storage.get("users", []) || [];
    const refreshed =
      users.find((u) => u.id === currentUser.id) || currentUser;
    const updatedConvo = (refreshed.chats || []).find((c) =>
      participantsMatch(c.participants, activeConversation.participants)
    );

    if (updatedConvo) activeConversation = updatedConvo;
    renderMessages(activeConversation);
    chatInput.value = "";
  });

  // --- NEW: read sellerId from selectedProduct in localStorage ---
  function getSellerIdFromSelectedProduct() {
    const raw = localStorage.getItem("selectedProduct");
    if (!raw) return null;
    try {
      const product = JSON.parse(raw);
      return product?.sellerId ?? null;
    } catch (e) {
      console.warn("selectedProduct parse error:", e);
      return null;
    }
  }

  function openChatWithSellerIfSelectedProductExists() {
    // Check if we should show the chat modal from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const showChat = urlParams.get('showChat');
    
    // Only proceed if the parameter is set to true
    if (showChat !== 'true') return;
    
    const sellerId = getSellerIdFromSelectedProduct();
    if (!sellerId) return; // nothing to do

    const users = Storage.get("users", []) || [];
    const sellerUser = users.find((u) => u.id === sellerId) || {
      id: sellerId,
      name: "Seller",
    };

    activeParticipant = sellerUser;

    // try find an existing conversation
    let convo = (currentUser.chats || []).find((c) =>
      participantsMatch(c.participants, {
        sender: currentUser.id,
        reciever: sellerId,
      })
    );

    // if not found, show a temporary conversation until first message is sent
    if (!convo) {
      convo = new Conversation(sellerId); // local object, not persisted until send
    }

    activeConversation = convo;
    chatModalTitle.innerText = `Chat with ${sellerUser?.name || sellerId}`;
    renderMessages(activeConversation);

    const modal = new bootstrap.Modal(document.getElementById("chatModal"));
    modal.show();
  }

  // initial render
  document.addEventListener("DOMContentLoaded", function() {
    loadChatList();
    openChatWithSellerIfSelectedProductExists();
  });
</script>  </body>
</html>
