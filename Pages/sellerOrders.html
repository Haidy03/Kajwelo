<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Kajwelo - Orders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script type="module" src="../JS/sellerOnly.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
            --sidebar-width: 280px;
            --topbar-height: 70px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f8f9fa;
            line-height: 1.6;
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #f6f7fa, #b99ad7, #ffa726, #ec407a);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 4s ease-in-out infinite;
            letter-spacing: -0.03em;
            margin-bottom: 6px;
            line-height: 1;
        }

        .logo p {
            color: #e5e5e5;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1;
        }

         @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            z-index: 1000;
            transition: left 0.3s ease-in-out;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.25rem;
        }

        .sidebar-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
        }

        .sidebar-menu {
            list-style: none;
            padding: 1rem 0;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .sidebar-link i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            transition: margin-left 0.3s ease-in-out;
            min-height: 100vh;
        }

        /* Top Bar */
        .topbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--topbar-height);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left {
            display: flex;
            align-items: center;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--dark-color);
            margin-right: 1rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }

        .topbar-right {
            display: flex;
            align-items: center;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--dark-color);
            margin-right: 1rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Orders Page Specific Styles */
        .orders-container {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .orders-header {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .stats-row {
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.info {
            border-left-color: var(--info-color);
        }

        .stat-card.danger {
            border-left-color: var(--danger-color);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filters-section {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .orders-table-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .orders-table {
            width: 100%;
            margin: 0;
        }

        .orders-table th {
            background: #f8f9fa;
            color: var(--dark-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 1rem;
            border: none;
            border-bottom: 2px solid #e5e7eb;
        }

        .orders-table td {
            padding: 1rem;
            border: none;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .orders-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .order-id {
            font-weight: 600;
            color: var(--primary-color);
        }

        .customer-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .customer-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .customer-details h6 {
            margin: 0;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .customer-details p {
            margin: 0;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .order-items {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .item-image {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }

        .item-count {
            background: #e5e7eb;
            color: var(--dark-color);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            white-space: nowrap;
        }

        .order-total {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark-color);
        }

        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.1);
            color: #d97706;
        }

        .status-processing {
            font-size: 0.6rem ;
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .status-shipped {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .status-delivered {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-action {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-view {
            background: var(--info-color);
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-edit {
            background: var(--warning-color);
            color: white;
        }

        .btn-edit:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .btn-accept {
            background: var(--success-color);
            color: white;
        }

        .btn-accept:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: var(--dark-color);
            border: 2px solid #e5e7eb;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box i {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }



        /* Table improvements */
        .table-responsive {
            border-radius: 0;
            margin: 0;
            padding: 0;
        }

        .orders-table {
            width: 100%;
            margin: 0;
            table-layout: fixed;
        }

        .orders-table th:nth-child(1) {
            width: 12%;
        }

        /* Order ID */
        .orders-table th:nth-child(2) {
            width: 20%;
        }

        /* Customer */
        .orders-table th:nth-child(3) {
            width: 15%;
        }

        /* Items */
        .orders-table th:nth-child(4) {
            width: 10%;
        }

        /* Total */
        .orders-table th:nth-child(5) {
            width: 12%;
        }

        /* Status */
        .orders-table th:nth-child(6) {
            width: 15%;
        }

        /* Date */
        .orders-table th:nth-child(7) {
            width: 16%;
        }

        /* Actions */

        .orders-table th,
        .orders-table td {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }



        /* Responsive Design */
        @media (min-width: 993px) {
            .sidebar {
                left: 0;
                position: fixed;
            }
            
            .main-content {
                margin-left: var(--sidebar-width);
            }
            
            .menu-toggle {
                display: none;
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 992px) {
            .orders-container {
                padding: 1rem;
            }

            .orders-header {
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .filters-section {
                padding: 1rem;
            }

            .table-header {
                padding: 1rem;
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
            }

            /* Hide table on mobile, show cards instead */
            .desktop-table {
                display: none;
            }

            .mobile-cards {
                display: block;
            }
        }

        @media (min-width: 993px) {
            .desktop-table {
                display: table;
            }

            .mobile-cards {
                display: none;
            }
        }

        /* Mobile Order Cards */
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .order-card-body {
            margin-bottom: 0.75rem;
        }

        .order-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }

        @media (max-width: 768px) {
            .topbar {
                padding: 0.75rem 1rem;
                height: 60px;
            }
            
            .page-title {
                font-size: 1.25rem;
            }

            .user-profile span {
                display: none;
            }

            .user-profile i {
                display: none;
            }

            .stat-card {
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 600px) {
            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }

            .btn-action {
                justify-content: center;
                width: 100%;
            }

            .order-card-footer {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
        }

        /* iPad specific styles */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                margin-left: 0;
            }

            .orders-table th,
            .orders-table td {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
        }

        /* Loading and Empty States */
        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
    </style>
</head>

<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" style="overflow-y: hidden;">
        <div class="sidebar-header">
            <div class="logo">
                <h1>Kajwelo</h1>
                <p>Seller Portal</p>
            </div>
        </div>
        
        <ul class="sidebar-menu">
            <li>
                <button class="sidebar-link" id="DashBtn" onclick="gotodashboard()">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </button>
            </li>
            <li>
                <button class="sidebar-link" id="AddProdBtn" onclick="gotoproducts()">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </button>
            </li>
            <li>
                <button class="sidebar-link active">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Orders</span>
                </button>
            </li>
            <li>
                <button class="sidebar-link" onclick="gotoanalytics()">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </button>
            </li>
            <li>
                <button class="sidebar-link" onclick="gotoCustomers()">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </button>
            </li>
            <li>
                <button class="sidebar-link" id="InventoryBtn" onclick="gotoInventory()">
                    <i class="fas fa-warehouse"></i>
                    <span>Inventory</span>
                </button>
            </li>
            <li>
                <button class="sidebar-link" onclick="gotoPending()">
                    <i class="fa-solid fa-hourglass-start"></i>
                    <span>Pending</span>
                </button>
            </li>
            <li>
                <button class="sidebar-link" onclick="gotoSettings()">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
            </li>
            <li>
                <button class="sidebar-link" onclick="gotoInbox()">
                    <i class="fa-solid fa-inbox"></i>
                    <span>Inbox</span>
                </button>
            </li>
        </ul>

        
        <div>
            <button class="sidebar-link" id="logoutBtn">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>LOG OUT</span>
            </button>
        </div>
        
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Orders</h1>
            </div>
            
            <div class="topbar-right">
                <div class="user-profile">
                    <div class="user-avatar"></div>
                    <span></span>
                </div>
            </div>
        </header>

        <!-- Orders Container -->
        <div class="orders-container">
            <!-- Orders Header with Stats -->
            <div class="orders-header">
                <h2 class="mb-3">Order Management</h2>
                <div class="stats-row">
                    <div class="row g-3">
                        <div class="col-xl-3 col-lg-4 col-md-6">
                            <div class="stat-card">
                                <div class="stat-number">0</div>
                                <div class="stat-label">Total Orders</div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-4 col-md-6">
                            <div class="stat-card success">
                                <div class="stat-number">0</div>
                                <div class="stat-label">Delivered</div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-4 col-md-6">
                            <div class="stat-card warning">
                                <div class="stat-number">0</div>
                                <div class="stat-label">Pending</div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-4 col-md-6">
                            <div class="stat-card info">
                                <div class="stat-number">0</div>
                                <div class="stat-label">Shipped</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Status Filter</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="dateFilter">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Order Value</label>
                        <select class="form-select" id="valueFilter">
                            <option value="">Any Amount</option>
                            <option value="0-50">$0 - $50</option>
                            <option value="50-100">$50 - $100</option>
                            <option value="100-200">$100 - $200</option>
                            <option value="200+">$200+</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6 d-flex align-items-end">
                        <button class="btn btn-secondary me-2" onclick="resetFilters()">
                            <i class="fas fa-refresh"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="exportOrders()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Orders Table Section -->
            <div class="orders-table-section">
                <div class="table-header">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="mb-0">Recent Orders</h5>
                        <span class="badge bg-primary">156 total</span>
                    </div>
                    <div class="search-box">
                        <input type="text" placeholder="Search orders..." id="orderSearch">
                        <i class="fas fa-search"></i>
                    </div>
                </div>

                <!-- Desktop Table -->
                <div class="table-responsive desktop-table">
                    <table class="table orders-table mb-0">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div class="mobile-cards" id="mobileOrderCards">
                    <!-- Mobile order cards will be populated here by JavaScript -->
                </div>


                    </div>
                </div>
    </main>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
                <div class="modal-body" id="orderDetailsContent">
                    <!-- Order details will be populated by JavaScript -->
        </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="acceptOrderBtn">Accept Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { Auth } from "../utils/auth.js";
        import { Storage } from "../utils/localStorageHelper.js";
        import { Customer } from "../models/Customer.js";
        import { Order } from "../models/Order.js";
        import { User } from "../models/User.js";
        import { showToast, showConfirmModal, showSuccessToast, showErrorToast, showWarningToast, showInfoToast, confirmAction } from "../utils/toastModal.js";

        // Global variables
        let orders = [];
        let filteredOrders = [];
        let currentUser = null;
        let customers = [];
        let currentOrderId = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            initializePage();
        });

        function initializePage() {
            currentUser = Auth.getCurrentUser();
            if (!currentUser) {
                window.location.href = "../login.html";
                return;
            }

            loadOrdersData();
            setupEventListeners();
            updateStats();
            renderOrders();
        }

        function loadOrdersData() {
            try {
                // Load orders from current user
                orders = currentUser.orders || [];

                // Load customers for order details
                const users = Storage.get("users", []);
                customers = users.filter(user => user instanceof Customer);

                console.log(`Found ${orders.length} orders in localStorage`);

                // Process orders to add customer information
                orders.forEach(order => {
                    order.customer = customers.find(customer => customer.id === order.customerId);
                    order.formattedDate = formatDate(order.orderedAt);
                    order.formattedTime = formatTime(order.orderedAt);
                    order.statusClass = getStatusClass(order.status);
                    order.displayStatus = getDisplayStatus(order.status);
                });

                // Group orders by orderId
                const groupedOrders = groupOrdersByOrderId(orders);
                orders = groupedOrders;
                console.log(orders);
                filteredOrders = [...orders];
            } catch (error) {
                console.error('Error loading orders data:', error);
                orders = [];
                filteredOrders = [];
            }
        }

        function groupOrdersByOrderId(orders) {
            const grouped = {};
            
            orders.forEach(order => {
                const orderId = order.orderId.split("-")[0]; // Get base orderId without suffix
                if (!grouped[orderId]) {
                    grouped[orderId] = {
                        orderId: orderId,
                        orders: [],
                        totalPrice: 0,
                        totalItems: 0,
                        customer: order.customer,
                        status: order.status,
                        statusClass: order.statusClass,
                        displayStatus: order.displayStatus,
                        orderedAt: order.orderedAt,
                        formattedDate: order.formattedDate,
                        formattedTime: order.formattedTime,
                        allProducts: []
                    };
                }
                
                grouped[orderId].orders.push(order);
                grouped[orderId].totalPrice += order.totalPrice;
                grouped[orderId].totalItems += order.products.length;
                grouped[orderId].allProducts.push(...order.products);
                
                // Use the earliest date for the group
                if (new Date(order.orderedAt) < new Date(grouped[orderId].orderedAt)) {
                    grouped[orderId].orderedAt = order.orderedAt;
                    grouped[orderId].formattedDate = order.formattedDate;
                    grouped[orderId].formattedTime = order.formattedTime;
                }
                
                // If any order in the group is pending, show as pending
                if (order.status === 'Pending') {
                    grouped[orderId].status = 'Pending';
                    grouped[orderId].statusClass = 'pending';
                    grouped[orderId].displayStatus = 'Pending';
                }
            });
            
            return Object.values(grouped);
        }

        function getStatusClass(status) {
            switch (status) {
                case "waiting to be Checked Out":
                    return "pending";
                case "Checked Out - Waiting to be Shipped":
                    return "processing";
                case "Shipped":
                    return "shipped";
                case "Delivered":
                    return "delivered";
                case "Cancelled":
                    return "cancelled";
                default:
                    return "pending";
            }
        }

        function getDisplayStatus(status) {
            switch (status) {
                case "waiting to be Checked Out":
                    return "Pending";
                case "Checked Out - Waiting to be Shipped":
                    return "Processing";
                case "Shipped":
                    return "Shipped";
                case "Delivered":
                    return "Delivered";
                case "Cancelled":
                    return "Cancelled";
                default:
                    return "Pending";
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        function updateStats() {
            const totalOrders = orders.length;
            const deliveredOrders = orders.filter(order => order.status === "Delivered").length;
            const pendingOrders = orders.filter(order => order.status === "waiting to be Checked Out").length;
            const shippedOrders = orders.filter(order => order.status === "Shipped").length;

            // Update stats cards
            const statCards = document.querySelectorAll('.stat-card');
            if (statCards.length >= 4) {
                statCards[0].querySelector('.stat-number').textContent = totalOrders;
                statCards[1].querySelector('.stat-number').textContent = deliveredOrders;
                statCards[2].querySelector('.stat-number').textContent = pendingOrders;
                statCards[3].querySelector('.stat-number').textContent = shippedOrders;
            }

            // Update notification badge
            const pendingOrdersCount = orders.filter(order => order.status === "waiting to be Checked Out").length;
            const notificationBadge = document.querySelector('.notification-badge');
            if (notificationBadge) {
                notificationBadge.textContent = pendingOrdersCount;
                notificationBadge.style.display = pendingOrdersCount > 0 ? 'flex' : 'none';
            }

            // Update total orders badge
            const totalBadge = document.querySelector('.badge.bg-primary');
            if (totalBadge) {
                totalBadge.textContent = `${totalOrders} total`;
            }
        }

        function renderOrders() {
            // Render desktop table
            renderDesktopTable();
            
            // Render mobile cards
            renderMobileCards();
        }

        function renderDesktopTable() {
            const tbody = document.getElementById('ordersTableBody');
            
            if (filteredOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-shopping-bag empty-icon"></i>
                                <h5>No orders found</h5>
                                <p>Try adjusting your search or filter criteria.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredOrders.map(orderGroup => `
                <tr>
                    <td>
                        <div class="order-id">#${orderGroup.orderId}</div>
                        ${orderGroup.orders.length > 1 ? `<small class="text-muted">${orderGroup.orders.length} orders</small>` : ''}
                    </td>
                    <td>
                        <div class="customer-info">
                            <div class="customer-avatar">
                                ${orderGroup.customer ? orderGroup.customer.name.split(' ').map(n => n[0]).join('') : 'N/A'}
                            </div>
                            <div class="customer-details">
                                <h6>${orderGroup.customer ? orderGroup.customer.name : 'Unknown Customer'}</h6>
                                <p>${orderGroup.customer ? orderGroup.customer.email : 'No email'}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="order-items">
                            <span class="item-count">${orderGroup.totalItems} items</span>
                        </div>
                    </td>
                    <td>
                        <div class="order-total">$${orderGroup.totalPrice.toFixed(2)}</div>
                    </td>
                    <td>
                        <span class="status-badge status-${orderGroup.statusClass}">
                            ${orderGroup.displayStatus}
                        </span>
                    </td>
                    <td>
                        <div>${orderGroup.formattedDate}</div>
                        <small class="text-muted">${orderGroup.formattedTime}</small>
                    </td>
                    <td>
                        <div class="action-buttons">
                             <button class="btn-action btn-view" onclick="viewOrder('${orderGroup.orderId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                             <button class="btn-action btn-accept" onclick="acceptOrder('${orderGroup.orderId}')">
                                 <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderMobileCards() {
            const container = document.getElementById('mobileOrderCards');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-bag empty-icon"></i>
                        <h5>No orders found</h5>
                        <p>Try adjusting your search or filter criteria.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredOrders.map(orderGroup => `
                <div class="order-card">
                    <div class="order-card-header">
                        <div class="order-id">#${orderGroup.orderId}</div>
                        <span class="status-badge status-${orderGroup.statusClass}">
                            ${orderGroup.displayStatus}
                        </span>
                    </div>
                    <div class="order-card-body">
                        <div class="customer-info mb-2">
                            <div class="customer-avatar">
                                ${orderGroup.customer ? orderGroup.customer.name.split(' ').map(n => n[0]).join('') : 'N/A'}
                            </div>
                            <div class="customer-details">
                                <h6>${orderGroup.customer ? orderGroup.customer.name : 'Unknown Customer'}</h6>
                                <p>${orderGroup.customer ? orderGroup.customer.email : 'No email'}</p>
                            </div>
                        </div>
                        <div class="order-items mb-2">
                            <span class="item-count">${orderGroup.totalItems} items</span>
                            ${orderGroup.orders.length > 1 ? `<small class="text-muted">(${orderGroup.orders.length} orders)</small>` : ''}
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="order-total">$${orderGroup.totalPrice.toFixed(2)}</div>
                            <div>
                                <div>${orderGroup.formattedDate}</div>
                                <small class="text-muted">${orderGroup.formattedTime}</small>
                            </div>
                        </div>
                    </div>
                    <div class="order-card-footer">
                        <div class="action-buttons">
                             <button class="btn-action btn-view" onclick="viewOrder('${orderGroup.orderId}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                             <button class="btn-action btn-accept" onclick="acceptOrder('${orderGroup.orderId}')">
                                 <i class="fas fa-check"></i> Accept
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Sidebar functionality
        window.toggleSidebar = function () {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const body = document.body;

            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');

            if (window.innerWidth < 993) {
                if (sidebar.classList.contains('open')) {
                    body.style.overflow = 'hidden';
                } else {
                    body.style.overflow = '';
                }
            }
        }

        // Navigation functions
        window.gotodashboard = function () {
            window.location.href = "sellerdashboard.html";
        }
        window.gotoproducts = function () {
            window.location.href = "SelleraAddProduct.html";
        }
        window.gotoOrders = function () {
            window.location.href = "sellerOrders.html";
        }
        window.gotoanalytics = function () {
            window.location.href = "SellerAnalytics.html";
        }
        window.gotoCustomers = function () {
            window.location.href = "sellerCustomers.html";
        }
        window.gotoInventory = function () {
            window.location.href = "SellerInventory.html";
        }
        window.gotoPending = function () {
            window.location.href = "sellerPending.html";
        }
        window.gotoSettings = function () {
            window.location.href = "SellerSettings.html";
        }
        window.gotoInbox = function () {
            window.location.href = "sellerInbox.html";
        }

        function setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('orderSearch');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }

            // Filter functionality
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', applyFilters);
            }

            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', applyFilters);
            }

            const valueFilter = document.getElementById('valueFilter');
            if (valueFilter) {
                valueFilter.addEventListener('change', applyFilters);
            }

            // Modal accept button
            const acceptOrderBtn = document.getElementById('acceptOrderBtn');
            if (acceptOrderBtn) {
                acceptOrderBtn.addEventListener('click', function() {
                    if (currentOrderId) {
                        acceptOrder(currentOrderId);
                        const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
                        modal.hide();
                    }
                });
            }

            // Sidebar links
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', function () {
                    if (window.innerWidth < 993) {
                        toggleSidebar();
                    }
                });
            });
        }

        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            filteredOrders = orders.filter(orderGroup =>
                orderGroup.orderId.toLowerCase().includes(searchTerm) ||
                (orderGroup.customer && orderGroup.customer.name.toLowerCase().includes(searchTerm)) ||
                (orderGroup.customer && orderGroup.customer.email.toLowerCase().includes(searchTerm))
            );
            renderOrders();
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const dateFilter = document.getElementById('dateFilter')?.value || '';
            const valueFilter = document.getElementById('valueFilter')?.value || '';

            filteredOrders = orders.filter(orderGroup => {
                let matches = true;

                // Status filter
                console.log( orderGroup.status);
                if (orderGroup.status==="Checked Out - Waiting to be Shipped") {
                    orderGroup.status="processing";
                }
                if (statusFilter && orderGroup.status.toLowerCase() !== statusFilter.toLowerCase()) {
                     console.log( orderGroup.status);
                    matches = false;
                }

                // Date filter
                if (dateFilter) {
                    const orderDate = new Date(orderGroup.orderedAt);
                    const today = new Date();

                    switch (dateFilter) {
                        case 'today':
                            matches = matches && orderDate.toDateString() === today.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matches = matches && orderDate >= weekAgo;
                            break;
                        case 'month':
                            matches = matches && orderDate.getMonth() === today.getMonth() && orderDate.getFullYear() === today.getFullYear();
                            break;
                        case 'quarter':
                            const quarter = Math.floor(today.getMonth() / 3);
                            const orderQuarter = Math.floor(orderDate.getMonth() / 3);
                            matches = matches && orderQuarter === quarter && orderDate.getFullYear() === today.getFullYear();
                            break;
                    }
                }

                // Value filter
                if (valueFilter) {
                    const total = orderGroup.totalPrice;
                    switch (valueFilter) {
                        case '0-50':
                            matches = matches && total >= 0 && total <= 50;
                            break;
                        case '50-100':
                            matches = matches && total > 50 && total <= 100;
                            break;
                        case '100-200':
                            matches = matches && total > 100 && total <= 200;
                            break;
                        case '200+':
                            matches = matches && total > 200;
                            break;
                    }
                }

                return matches;
            });

            renderOrders();
        }

        window.resetFilters = function () {
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('valueFilter').value = '';
            document.getElementById('orderSearch').value = '';
            filteredOrders = [...orders];
            renderOrders();
        }

        window.exportOrders = function () {
            const csvContent = generateCSV(filteredOrders);
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function generateCSV(orders) {
            const headers = ['Order ID', 'Customer Name', 'Customer Email', 'Items Count', 'Total', 'Status', 'Date', 'Time', 'Number of Orders'];
            const rows = orders.map(orderGroup => [
                orderGroup.orderId,
                orderGroup.customer ? orderGroup.customer.name : 'Unknown Customer',
                orderGroup.customer ? orderGroup.customer.email : 'No email',
                orderGroup.totalItems,
                `${orderGroup.totalPrice.toFixed(2)}`,
                orderGroup.displayStatus,
                orderGroup.formattedDate,
                orderGroup.formattedTime,
                orderGroup.orders.length
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        window.viewOrder = function (orderId) {
            const orderGroup = orders.find(o => o.orderId === orderId);
            if (orderGroup) {
                currentOrderId = orderId;
                showOrderDetailsModal(orderGroup);
            }
        }

        window.acceptOrder = function (orderId) {
            const orderGroup = orders.find(o => o.orderId === orderId && o.status !== "Shipped" && o.status !== "Delivered" && o.status !== "Cancelled");
            if (orderGroup) {
                const orderCount = orderGroup.orders.length;
                const message = orderCount > 1 
                    ? `Are you sure you want to accept ${orderCount} orders with ID ${orderId}? This will update all orders to "Shipped".`
                    : `Are you sure you want to accept order ${orderId}? This will update the status to "Shipped".`;
                
                showConfirmModal(message, () => {
                    updateOrderStatus(orderId, "Shipped");
                });
            }else {
                showToast('Order cannot be accepted. It may have already been processed.', 'error');
            }
        }

        function showOrderDetailsModal(orderGroup) {
            const modalContent = document.getElementById('orderDetailsContent');
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Order Information</h6>
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>Order ID:</strong></td>
                                <td>${orderGroup.orderId}</td>
                            </tr>
                            <tr>
                                <td><strong>Number of Orders:</strong></td>
                                <td>${orderGroup.orders.length} order${orderGroup.orders.length > 1 ? 's' : ''}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td>
                                    <span class="status-badge status-${orderGroup.statusClass}">
                                        ${orderGroup.displayStatus}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Date:</strong></td>
                                <td>${orderGroup.formattedDate} at ${orderGroup.formattedTime}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Amount:</strong></td>
                                <td><strong>$${orderGroup.totalPrice.toFixed(2)}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Items Count:</strong></td>
                                <td>${orderGroup.totalItems} items</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Customer Information</h6>
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>${orderGroup.customer ? orderGroup.customer.name : 'Unknown Customer'}</td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>${orderGroup.customer ? orderGroup.customer.email : 'No email'}</td>
                            </tr>
                            <tr>
                                <td><strong>Phone:</strong></td>
                                <td>${orderGroup.customer ? (orderGroup.customer.phone || 'Not provided') : 'Not provided'}</td>
                            </tr>
                            <tr>
                                <td><strong>Address:</strong></td>
                                <td>${orderGroup.customer ? (orderGroup.customer.address || 'Not provided') : 'Not provided'}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                ${orderGroup.orders.length > 1 ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-primary">Individual Orders</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Status</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${orderGroup.orders.map(order => `
                                        <tr>
                                            <td>${order.orderId}</td>
                                            <td>
                                                <span class="status-badge status-${order.statusClass}">
                                                    ${order.displayStatus}
                                                </span>
                                            </td>
                                            <td>${order.products.length} items</td>
                                            <td>$${order.totalPrice.toFixed(2)}</td>
                                            <td>${order.formattedDate}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-primary">All Order Items</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product ID</th>
                                        <th>Size</th>
                                        <th>Color</th>
                                        <th>Quantity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${orderGroup.allProducts.map(product => `
                                        <tr>
                                            <td>${product.productId}</td>
                                            <td>${product.size}</td>
                                            <td>${product.color}</td>
                                            <td>${product.quantity}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }

        function updateOrderStatus(orderId, newStatus) {
            try {
                // Find the order group
                const orderGroup = orders.find(o => o.orderId === orderId);
                if (!orderGroup) {
                    showToast('Order not found!', 'error');
                    return;
                }

                // Update all orders in the group
                orderGroup.orders.forEach(order => {
                    // Update order in current user (seller)
                    const orderIndex = currentUser.orders.findIndex(o => o.orderId === order.orderId);
            if (orderIndex !== -1) {
                        currentUser.orders[orderIndex].status = newStatus;
                    }

                    // Update order in customer's order history
                    if (order.customer) {
                        const customerOrderIndex = order.customer.orderHistory.findIndex(o => o.orderId === order.orderId);
                        if (customerOrderIndex !== -1) {
                            order.customer.orderHistory[customerOrderIndex].status = newStatus;
                            User.updateInDB(order.customer);
                        }
                    }
                });

                // Update current user in localStorage
                User.updateCurrentUser(currentUser);

                // Reload data and update UI
                loadOrdersData();
                updateStats();
                renderOrders();

                // Show success message
                const orderCount = orderGroup.orders.length;
                const message = orderCount > 1 
                    ? `${orderCount} orders with ID ${orderId} have been ${newStatus.toLowerCase()} successfully!`
                    : `Order ${orderId} has been ${newStatus.toLowerCase()} successfully!`;
                showToast(message, 'success');
            } catch (error) {
                console.error('Error updating order status:', error);
                showToast('Error updating order status. Please try again.', 'error');
            }
        }

        // Handle window resize
        window.addEventListener('resize', function () {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const body = document.body;

            if (window.innerWidth >= 993) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                body.style.overflow = '';
            }
        });

        // Touch device improvements
        if ('ontouchstart' in window) {
            document.body.classList.add('touch-device');
            document.addEventListener('touchstart', function () { }, { passive: true });
        }

        // iPad detection
        function isiPad() {
            return navigator.userAgent.match(/(iPad)/) ||
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        if (isiPad()) {
            document.body.classList.add('ipad-device');
        }
    </script>
</body>

</html>