<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>product details</title>

    <link rel="stylesheet" href="../CSS/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../CSS/userprofileStyle.css" />

    <link rel="stylesheet" href="../CSS/Finalhomepage.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.7/css/bootstrap.min.css"
    />
    <script type="module" src="../utils/logout.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .broken-image-placeholder {
        width: 100%;
        height: 300px;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        border: 1px dashed #dee2e6;
        border-radius: 0.375rem;
      }
      .broken-image-placeholder i {
        font-size: 3rem;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body class="bg-light">
    <br />
    <br />
    <div class="container py-5">
      <a
        href="javascript:void(0);"
        onclick="window.history.back();"
        class="btn btn-link mb-3"
      >
        <i class="fa-solid fa-arrow-left"></i> Back to Products
      </a>

      <div id="product-details" class="row justify-content-center"></div>
    </div>

    <script>
      (function () {
        // Function to get user name by ID
        function getUserNameById(userId) {
          try {
            const users = JSON.parse(localStorage.getItem("users") || "[]");
            const user = users.find((u) => u.id === userId);
            return user ? user.name : null;
          } catch (error) {
            console.error("Error getting user name:", error);
            return null;
          }
        }

        // Function to handle broken images
        function handleBrokenImage(img) {
          // Create a placeholder div
          const placeholder = document.createElement("div");
          placeholder.className = "broken-image-placeholder";
          placeholder.innerHTML =
            '<i class="fa-solid fa-image"></i><p>Image not available</p>';

          // Replace the image with the placeholder
          img.parentNode.replaceChild(placeholder, img);
        }

        // read selected product (original object)
        const raw = localStorage.getItem("selectedProduct");
        let original = null;
        try {
          original = raw ? JSON.parse(raw) : null;
        } catch {
          original = null;
        }

        const container = document.getElementById("product-details");
        if (!container) return;

        if (!original) {
          container.innerHTML = `
      <div class="col-md-8">
        <div class="alert alert-warning shadow-sm">
          <strong>Heads up:</strong> No product selected. 
          <a href="./products.html" class="alert-link">Go back to products</a>.
        </div>
      </div>`;
          return;
        }

        // Normalize the product into a stable shape for rendering while
        // keeping the original object intact for storage/transfer.
        function normalizeProduct(p) {
          if (!p || typeof p !== "object") return null;

          // Get brand name from user ID if available
          let brandName = p.brand || p.sellerName || "";

          // If we have a sellerId but no brand name, try to get it from users array
          if ((!brandName || brandName === "") && p.sellerId) {
            const userName = getUserNameById(p.sellerId);
            if (userName) {
              brandName = userName;
            }
          }

          const currentprice =
            p.currentprice ?? p.salePrice ?? p.sale_price ?? p.price ?? 0;
          const oldprice =
            p.oldprice ??
            (p.salePrice && p.price ? p.price : p.old_price ?? null) ??
            null;

          return {
            id: p.id,
            title: p.title ?? p.name ?? "Unnamed product",
            brand: brandName || p.sellerId || "",
            image: p.image ?? p.img ?? null, // Set to null instead of external URL
            description: p.description ?? "",
            currentprice,
            oldprice,
            sellerId: p.sellerId ?? (p.seller && p.seller.id) ?? null,
            raw: p, // keep a pointer to original if needed
          };
        }

        const product = normalizeProduct(original);
        if (!product) {
          container.innerHTML = `
      <div class="col-md-8">
        <div class="alert alert-danger shadow-sm">
          <strong>Error:</strong> Product data is invalid.
        </div>
      </div>`;
          return;
        }

        // Render using the normalized product
        container.innerHTML = `
    <div class="col-md-10 col-lg-8">
      <div class="card shadow-sm">
        <div class="row g-0">
          <div class="col-md-5 p-3 d-flex align-items-center justify-content-center">
            ${
              product.image
                ? `<img src="${product.image}" alt="${product.title}" class="img-fluid rounded" id="product-image">`
                : `<div class="broken-image-placeholder">
                 <i class="fa-solid fa-image"></i>
                 <p>Image not available</p>
               </div>`
            }
          </div>
          <div class="col-md-7">
            <div class="card-body">
              <h2 class="card-title h3">${product.title}</h2>
<p class="text-muted mb-2 d-flex align-items-center gap-2">
  <strong>Brand:</strong> ${product.brand || "—"}
<button class="btn btn-outline-primary btn-sm rounded-circle ms-2" 
        id="messageBtn" title="Message">
  <i class="fa-solid fa-message"></i>
</button>

</p>
              <p class="fs-4 mb-4">
                <span class="text-success fw-bold">${Number(
                  product.currentprice
                ).toLocaleString()} $</span>
                ${
                  product.oldprice
                    ? `<span class="old-price text-muted ms-2">${Number(
                        product.oldprice
                      ).toLocaleString()} $</span>`
                    : ""
                }
              </p>

              <div class="d-flex gap-2">
                <button id="addCartBtn" class="btn btn-primary">
                  <i class="fa-solid fa-cart-shopping"></i> Add to Cart
                </button>
                <button id="wishlistBtn" class="btn btn-outline-danger">♡</button>
              </div>

              <hr class="my-4">

              <div class="small text-muted">
                <p class="mb-1">SKU: #${product.id}</p>
                <p class="mb-0">Ships within 2–4 days.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Optional: related actions -->
      <div class="d-flex justify-content-between mt-3">
       
      </div>
    </div>
  `;

        // Add error handler for the product image if it exists
        const productImage = document.getElementById("product-image");
        if (productImage) {
          productImage.addEventListener("error", function () {
            handleBrokenImage(this);
          });
        }

        const messageBtn = document.getElementById("messageBtn");
        const wishlistBtn = document.getElementById("wishlistBtn");
        const addCartBtn = document.getElementById("addCartBtn");

        // message button checks sellerId on original (keeps original structure)
        messageBtn.addEventListener("click", function () {
          if (!original) {
            alert("No selected product found. Please select a product first.");
            return;
          }
          const sellerId =
            original.sellerId ??
            (original.seller && original.seller.id) ??
            null;
          if (!sellerId) {
            alert("Seller ID not found on this product.");
            return;
          }
          // keep previous behaviour: open chat page
          window.location.href = "/Pages/chatWithSeller.html?showChat=true";
        });

        // --- Initialize Wishlist State ---
        (function initWishlistState() {
          const loggedInUser = JSON.parse(
            localStorage.getItem("loggedInUser") || "null"
          );
          if (!loggedInUser || !Array.isArray(loggedInUser.wishlist)) return;
          const isIn = loggedInUser.wishlist.some(
            (item) => String(item.id) === String(product.id)
          );
          if (isIn) {
            wishlistBtn.textContent = "❤";
            wishlistBtn.classList.add("wishlist-active");
          }
        })();

        wishlistBtn.addEventListener("click", function () {
          let loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
          if (!loggedInUser) {
            alert("You need to log in to use wishlist!");
            window.location.href = "/login.html";
            return;
          }
          if (!Array.isArray(loggedInUser.wishlist)) {
            loggedInUser.wishlist = [];
          }

          // we store the original object so other pages that expect name/price are fine
          const idx = loggedInUser.wishlist.findIndex(
            (item) => String(item.id) === String(product.id)
          );
          if (idx === -1) {
            loggedInUser.wishlist.push(original);
            wishlistBtn.textContent = "❤";
            wishlistBtn.classList.add("wishlist-active");
          } else {
            loggedInUser.wishlist.splice(idx, 1);
            wishlistBtn.textContent = "♡";
            wishlistBtn.classList.remove("wishlist-active");
          }
          localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

          let users = JSON.parse(localStorage.getItem("users")) || [];
          const userIndex = users.findIndex((u) => u.id === loggedInUser.id);
          if (userIndex !== -1) {
            users[userIndex] = loggedInUser;
            localStorage.setItem("users", JSON.stringify(users));
          }
        });

        // --- Initialize Cart State ---
        (function initCartState() {
          const loggedInUser = JSON.parse(
            localStorage.getItem("loggedInUser") || "null"
          );
          if (!loggedInUser || !Array.isArray(loggedInUser.cart)) return;
          const isIn = loggedInUser.cart.some(
            (item) => String(item.id) === String(product.id)
          );
          if (isIn) {
            addCartBtn.textContent = "✔ Added to Cart";
            addCartBtn.classList.add("btn-success");
          }
        })();

        addCartBtn.addEventListener("click", function () {
          let loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
          if (!loggedInUser) {
            alert("You need to log in to use the cart!");
            window.location.href = "/login.html";
            return;
          }
          if (!Array.isArray(loggedInUser.cart)) {
            loggedInUser.cart = [];
          }

          const idx = loggedInUser.cart.findIndex(
            (item) => String(item.id) === String(product.id)
          );
          if (idx === -1) {
            // store original object in cart for compatibility
            loggedInUser.cart.push(original);
            addCartBtn.textContent = "✔ Added to Cart";
            addCartBtn.classList.remove("btn-primary");
            addCartBtn.classList.add("btn-success");
          } else {
            loggedInUser.cart.splice(idx, 1);
            addCartBtn.innerHTML = `<i class="fa-solid fa-cart-shopping"></i> Add to Cart`;
            addCartBtn.classList.remove("btn-success");
            addCartBtn.classList.add("btn-primary");
          }
          localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

          let users = JSON.parse(localStorage.getItem("users")) || [];
          const userIndex = users.findIndex((u) => u.id === loggedInUser.id);
          if (userIndex !== -1) {
            users[userIndex] = loggedInUser;
            localStorage.setItem("users", JSON.stringify(users));
          }
        });
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
