<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/AdminDashBoard_styles.css">
</head>

<body>
  <div class="container-fluid" id="mainWrapper">
    <div class="row">
      <aside class="sidebar col-lg-2 col-md-3 d-md-flex flex-column">
        <div class="sidebar-logo d-flex align-items-center">
          <i class="fas fa-store me-2"></i>
          <span class="d-none d-lg-inline">AdminPanel</span>
        </div>

        <button class="btn btn-dark mobile-menu-btn" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>

        <div class="sidebar-menu py-3">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span class="d-none d-lg-inline">Dashboard</span>
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="productsDropdown" role="button"
                data-bs-toggle="dropdown">
                <i class="fas fa-box-open"></i>
                <span class="d-none d-lg-inline">Products</span>
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-section="products">All Products</a></li>
                <li><a class="dropdown-item" href="#" data-section="categories">Categories</a></li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="sellers">
                <i class="fas fa-user-tie"></i>
                <span class="d-none d-lg-inline">Sellers</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="customers">
                <i class="fas fa-users"></i>
                <span class="d-none d-lg-inline">Customers</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="verificationRequests">
                <i class="fas fa-check-circle"></i>
                <span class="d-none d-lg-inline">V Requests</span>
                <span class="badge bg-danger ms-2" id="verificationBadge">3</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="inbox">
                <i class="fas fa-inbox"></i>
                <span class="d-none d-lg-inline">Inbox</span>
                <span class="badge bg-danger ms-2" id="inboxBadge">5</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="admins">
                <i class="fas fa-user-shield"></i>
                <span class="d-none d-lg-inline">Admins</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="analysis">
                <i class="fas fa-chart-pie"></i>
                <span class="d-none d-lg-inline">Analysis</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="settings">
                <i class="fas fa-cog"></i>
                <span class="d-none d-lg-inline">Settings</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="sidebar-footer p-3">
          <a href="#" id="sidebarLogoutBtn" class="btn btn-outline-light w-100">
            <i class="fas fa-sign-out-alt"></i>
            <span class="d-none d-lg-inline">Log Out</span>
          </a>
        </div>
      </aside>

      <main class="main-content col-lg-10 col-md-9 ms-sm-auto">
        <header class="main-header d-flex flex-wrap align-items-center justify-content-between">
          <button class="btn btn-light me-2" id="headerSidebarToggle" aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="h4 mb-0" id="sectionTitle">
            <i class="fas fa-tachometer-alt me-2"></i>
            Dashboard
          </h1>

          <div class="search-box flex-grow-1 mx-3">
            <i class="fas fa-search"></i>
            <input type="search" class="form-control" id="searchInput" placeholder="Search...">
          </div>

          <div class="d-flex align-items-center">
            <div class="dropdown">
              <button class="btn btn-light dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                <span class="d-none d-md-inline">Admin User</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" data-section="profile"><i class="fas fa-user me-2"></i>Profile</a>
                </li>
                <li><a class="dropdown-item" href="#" data-section="settings"><i
                      class="fas fa-cog me-2"></i>Settings</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" id="dropdownLogoutBtn" href="#"><i
                      class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
              </ul>
            </div>
          </div>
        </header>

        <section class="p-4" id="contentSection">
          <div class="card" id="dataTableCard" style="display: none;">
            <div class="card-header d-flex flex-wrap align-items-center justify-content-between">
              <h2 class="h5 mb-0" id="tableTitle"></h2>
              <div class="header-actions">
                <!-- Bulk Actions -->
                <div class="bulk-actions me-2" id="bulkActionsContainer" style="display: none;">
                  <button class="btn btn-outline-danger btn-sm" id="bulkDeleteBtn">
                    <i class="fas fa-trash me-1"></i>Delete Selected (<span id="selectedCount">0</span>)
                  </button>
                </div>

                <div class="dropdown me-2">
                  <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-filter me-2"></i>Filter
                  </button>
                  <ul class="dropdown-menu" id="filterDropdown"></ul>
                </div>
                <button class="btn btn-outline-secondary me-2" id="seeAllBtn">
                  <i class="fas fa-eye me-2"></i>See All
                </button>
                <button class="btn btn-primary" id="addItemBtn">
                  <i class="fas fa-plus me-2"></i>
                  <span id="addButtonText">Add Item</span>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover" id="dataTable">
                  <thead id="tableHeader"></thead>
                  <tbody id="tableBody"></tbody>
                </table>
              </div>
              <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
              </nav>
            </div>
          </div>

          <div id="comingSoonContainer">
            <!-- Content will be loaded here -->
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Add/Edit Item Modal -->
  <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemModalTitle">Add Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="itemForm" novalidate>
            <!-- Dynamic form content will be inserted here -->
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveItemBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Seller Modal -->
  <div class="modal fade" id="messageSellerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="messageSellerTitle">Send Message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="messageForm" novalidate>
            <div class="mb-3">
              <label for="messageSubject" class="form-label">Subject</label>
              <input type="text" class="form-control" id="messageSubject" required>
              <div class="invalid-feedback">Please enter a subject</div>
            </div>
            <div class="mb-3">
              <label for="messageBody" class="form-label">Message</label>
              <textarea class="form-control" id="messageBody" rows="5" required></textarea>
              <div class="invalid-feedback">Please enter a message</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="sendMessageBtn">Send Message</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Confirmation Modal -->
  <div class="modal fade" id="passwordConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="passwordConfirmForm">
            <div class="mb-3">
              <label for="currentPassword" class="form-label">Current Password</label>
              <input type="password" class="form-control" id="currentPassword" required>
              <div class="invalid-feedback">Please enter your current password</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmPasswordBtn">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Authorization Guard: redirects non-admins to accessDeniedPage.html -->
  <script type="module">
    import { Auth } from "../utils/auth.js";
    import { Storage } from "../utils/localStorageHelper.js";

    // Enforce admin-only access
    Auth.apply_Autherization("admin");

    // Expose admin access level for UI/permissions logic
    const user = Storage.get("loggedInUser");
    const lvl = Number(user?.adminLevel) || 1; // 1: product, 2: super, 3: master
    window.adminAccess = {
      level: lvl,
      isMaster: lvl === 3,
      isSuper: lvl === 2,
      isProduct: lvl === 1,
    };
  </script>

  <!-- JavaScript Files -->
  <script src="js/AdminDashBoard_data.js"></script>
  <script src="js/AdminDashBoard_app.js"></script>
  <script src="js/AdminDashBoard_ui.js"></script>
  <script src="js/AdminDashBoard_table.js"></script>
  <script src="js/AdminDashBoard_settings.js"></script>
  <script src="js/AdminDashBoard_modals.js"></script>

  <!-- Bridge loader and adapters -->
  <script type="module">
    import "./js/AdminDashBoard_bridge.js";
    import { Auth } from "../utils/auth.js";

    // Adapter: persist actions and enforce roles without changing external files
    (function () {
      function safe(fn) {
        try { fn(); } catch (e) { console.error(e); }
      }

      // Hook table action handlers after initial render
      document.addEventListener('DOMContentLoaded', function () {
        // Enforce sidebar visibility by role (product admin limited)
        const acc = window.adminAccess || { level: 1 };
        if (acc.isProduct) {
          const allowed = new Set(['dashboard', 'verificationRequests', 'settings']);
          document.querySelectorAll('.sidebar-menu [data-section]')
            .forEach(a => { if (!allowed.has(a.dataset.section)) a.classList.add('disabled'); });
        }

        // Override functions to persist changes
        const origVerifyItem = window.verifyItem;
        window.verifyItem = function (id) {
          const res = window.AdminOps.verifyRequestById(id);
          if (res?.success) {
            // Rebuild local DS by reloading page data
            safe(() => window.location.reload());
          } else {
            safe(() => showToast(res?.message || 'Verification failed', 'error'));
          }
        };

        const origDeleteItem = window.deleteItem;
        window.deleteItem = function (id) {
          showConfirmModal('Are you sure you want to delete this item?', () => {
            const section = window.appState?.currentSection;
            let res = { success: false };
            if (section === 'products') res = window.AdminOps.deleteProductById(id);
            else if (section === 'categories') {
              // Find category name in current data
              const cat = (window.dataStore?.categories || []).find(c => c.id === id);
              if (cat) res = window.AdminOps.deleteCategoryProducts(cat.name);
            }
            else if (section === 'sellers' || section === 'customers' || section === 'admins') res = window.AdminOps.deleteUserById(id);
            else if (section === 'verificationRequests') {
              const arr = window.dataStore?.verificationRequests || [];
              const req = arr.find(r => String(r.id) === String(id));
              if (req) {
                let delRes = { success: false };
                if (req.type === 'seller') {
                  // Use Auth.deleteAccount for seller requests
                  try {
                    delRes = Auth.deleteAccount(req.entityId);
                  } catch (e) {
                    delRes = { success: false, message: e?.message || 'delete_failed' };
                  }
                } else if (req.type === 'product') {
                  // Remove the product from its owner
                  delRes = window.AdminOps.deleteProductById(req.entityId);
                } else {
                  delRes = { success: false, message: 'unsupported_request_type' };
                }

                if (delRes?.success) {
                  // Remove the request from the in-memory list and refresh UI
                  const idx2 = arr.findIndex(r => String(r.id) === String(id));
                  if (idx2 !== -1) arr.splice(idx2, 1);
                  safe(() => { renderTable(); updatePagination(); updateBadges(); });
                  res = { success: true };
                } else {
                  res = delRes;
                }
              } else {
                res = { success: false, message: 'request_not_found' };
              }
            }
            else if (section === 'inbox') res = window.AdminOps.deleteInboxById(id);

            if (res?.success) {
              safe(() => window.location.reload());
            } else {
              safe(() => showToast(res?.message || 'Delete failed', 'error'));
            }
          });
        };

        const origMarkAsRead = window.markAsRead;
        window.markAsRead = function (id) {
          const res = window.AdminOps.markInboxReadById(id);
          if (res?.success) {
            safe(() => window.location.reload());
          } else {
            safe(() => showToast(res?.message || 'Mark as read failed', 'error'));
          }
        };

        const origReset = window.resetSellerPassword;
        window.resetSellerPassword = function (id) {
          const res = window.AdminOps.resetSellerPassword(id, '123456');
          if (res?.success) {
            safe(() => showToast('Seller password has been reset to 123456', 'success'));
          } else {
            safe(() => showToast(res?.message || 'Reset failed', 'error'));
          }
        };

        // Role-based UI restrictions
        if (acc.isSuper) {
          // disable admin management buttons in Admins section at render time via CSS class
          const style = document.createElement('style');
          style.textContent = `
        [data-section="admins"] ~ #contentSection .delete-item,
        [data-section="admins"] ~ #contentSection .view-item,
        [data-section="admins"] ~ #contentSection #addItemBtn { pointer-events:none; opacity:0.5; }
      `;
          // Fallback: when Admins section active, disable buttons
          document.head.appendChild(style);
        }

        if (acc.isProduct) {
          // Section access is already limited via sidebar; keep action buttons enabled
        }
        // Logout handlers
        document.getElementById('sidebarLogoutBtn')?.addEventListener('click', (e) => {
          e.preventDefault();
          try { localStorage.removeItem('loggedInUser'); } catch { }
          window.location.href = '../FinalHomePage.html';
        });
        document.getElementById('dropdownLogoutBtn')?.addEventListener('click', (e) => {
          e.preventDefault();
          try { localStorage.removeItem('loggedInUser'); } catch { }
          window.location.href = '../FinalHomePage.html';
        });
      });
    })();
  </script>

  <!-- Patches: persist bulk delete and fix settings password validation/persistence -->
  <script type="module">
    import { Auth } from "../utils/auth.js";
    import { Storage } from "../utils/localStorageHelper.js";

    (function () {
      // Ensure disabled links are truly disabled
      const style = document.createElement('style');
      style.textContent = `
    .sidebar-menu .nav-link.disabled { pointer-events: none; opacity: 0.5; }
  `;
      document.head.appendChild(style);

      // Validate current password against actual stored credentials (using Auth)
      window.validateCurrentPassword = function () {
        const input = document.getElementById('currentPassword');
        if (!input) return true; // no field
        const user = Storage.get('loggedInUser');
        if (!input.value) {
          input.setCustomValidity("Current password is required to save any changes");
          input.classList.add('is-invalid');
          return false;
        }
        const res = Auth.login(user.email, input.value);
        if (res && res.success) {
          input.setCustomValidity("");
          input.classList.remove('is-invalid');
          return true;
        } else {
          input.setCustomValidity("Current password is incorrect");
          input.classList.add('is-invalid');
          return false;
        }
      };

      // Persist settings to localStorage (users + loggedInUser)
      window.saveAdminSettings = function () {
        const form = document.getElementById('adminSettingsForm');
        const nameEl = document.getElementById('adminName');
        const emailEl = document.getElementById('adminEmail');
        const newPassEl = document.getElementById('newPassword');
        const confirmEl = document.getElementById('confirmNewPassword');
        const currEl = document.getElementById('currentPassword');

        if (!window.validateCurrentPassword()) {
          form?.classList.add('was-validated');
          return;
        }

        const users = Storage.get('users', []);
        const logged = Storage.get('loggedInUser');
        const idx = users.findIndex(u => u.id === logged.id);
        if (idx === -1) {
          showToast('Current admin not found in storage', 'error');
          return;
        }

        users[idx].name = nameEl?.value || users[idx].name;
        users[idx].email = emailEl?.value || users[idx].email;
        if (newPassEl && newPassEl.value) {
          // encode password before saving (matches how passwords are stored)
          function encodeUnicode(str) { try { return btoa(unescape(encodeURIComponent(str))); } catch { return str; } }
          users[idx].password = encodeUnicode(newPassEl.value);
        }

        Storage.set('users', users);
        Storage.set('loggedInUser', users[idx]);

        const container = document.querySelector('.settings-container');
        if (container) {
          const alertHTML = `
        <div class="alert alert-success alert-dismissible fade show">
          <i class="fas fa-check-circle me-2"></i>
          Settings saved successfully!
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
          const prev = container.querySelector('.alert-success');
          if (prev) prev.remove();
          container.insertAdjacentHTML('afterbegin', alertHTML);
          container.scrollIntoView({ behavior: 'smooth' });
        }

        if (currEl) currEl.value = '';
        if (newPassEl) newPassEl.value = '';
        if (confirmEl) confirmEl.value = '';
        form?.classList.remove('was-validated');
        if (typeof window.updatePasswordStrength === 'function') window.updatePasswordStrength('');
      };

      // Persistent bulk delete
      window.bulkDeleteItems = function () {
        const selected = window.appState?.selectedItems || new Set();
        if (selected.size === 0) return;
        const count = selected.size;
        if (!confirm(`Are you sure you want to delete ${count} selected item(s)?`)) return;

        const section = window.appState.currentSection;
        let ok = 0;
        if (section === 'categories') {
          const ids = Array.from(selected);
          ids.forEach(id => {
            const cat = (window.dataStore?.categories || []).find(c => c.id === id);
            if (cat) {
              const res = window.AdminOps.deleteCategoryProducts(cat.name);
              if (res?.success) ok++;
            }
          });
        } else {
          const ids = Array.from(selected);
          const res = window.AdminOps.bulkDelete(section, ids);
          if (res?.success) ok = res.count;
        }

        window.location.reload();
      };
    })();
  </script>
</body>

</html>